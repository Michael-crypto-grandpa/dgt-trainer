<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DGT iPhone Trainer ‚Äî Lectura F√°cil</title>
  <meta name="description" content="Entrenador sencillo para la teor√≠a de conducir en Espa√±a. Modo pr√°ctica y examen, perfiles separados y soporte de im√°genes. Estilo Lectura F√°cil (no oficial)." />
  <style>
    :root{ --bg:#0b0f14; --panel:#121821; --card:#18202b; --ink:#e7eef7; --muted:#a9b7c8; --acc:#5bd4ff; --good:#1ec28b; --bad:#ff6b6b}
    *{box-sizing:border-box}
    html,body{margin:0; height:100%; font-family:-apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink)}
    .wrap{max-width:900px; margin:0 auto; padding:max(12px,env(safe-area-inset-top)) 12px calc(12px + env(safe-area-inset-bottom));}
    header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(11,15,20,.98) 80%, rgba(11,15,20,0)); backdrop-filter:saturate(1.2) blur(8px); border-bottom:1px solid rgba(255,255,255,.05); padding:8px 4px}
    h1{margin:0; font-size:20px}
    .subtitle{color:var(--muted); font-size:12px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .grow{flex:1}
    .card{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px}
    .btn{background:#10161f; border:1px solid rgba(255,255,255,.1); color:var(--ink); padding:10px 12px; border-radius:12px; font-weight:600; cursor:pointer}
    .btn.small{padding:8px 10px; font-weight:500}
    .btn.primary{background:linear-gradient(180deg,#1a5cff,#147aff)}
    .btn.ghost{background:transparent}
    .seg{display:flex; gap:6px; background:rgba(255,255,255,.04); padding:4px; border-radius:12px; border:1px solid rgba(255,255,255,.06)}
    .seg button{flex:1; padding:8px 10px; border:none; border-radius:10px; font-weight:600; color:var(--ink); background:transparent}
    .seg button.active{background:var(--acc); color:#00131f}
    .qtxt{font-size:18px; line-height:1.35}
    .choices{display:grid; gap:8px}
    .choice{display:flex; gap:10px; align-items:flex-start; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.07); padding:10px 12px; border-radius:12px; cursor:pointer}
    .choice.correct{outline:2px solid var(--good)}
    .choice.incorrect{outline:2px solid var(--bad)}
    .muted{color:var(--muted)}
    .bar{height:8px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden}
    .bar>span{display:block; height:100%; background:linear-gradient(90deg,#5bd4ff,#1ec28b)}
    .image{width:100%; border-radius:12px; border:1px solid rgba(255,255,255,.06)}
    .hidden{display:none!important}
    input[type="text"], select{background:#0f141c; color:var(--ink); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:10px 12px; width:100%}
    label.file{display:inline-flex; align-items:center; gap:8px; cursor:pointer}
    input[type="file"]{display:none}
    .grid{display:grid; gap:10px}
    .two{grid-template-columns:1fr}
    @media(min-width:740px){.two{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <h1>üìò DGT iPhone Trainer ‚Äî Lectura F√°cil</h1>
          <div class="subtitle">Entrena para la teor√≠a (ES). Funciona en iPhone, guarda progreso en el dispositivo.</div>
        </div>
        <div class="row">
          <div class="seg" role="tablist">
            <button id="modePractice" class="active">Pr√°ctica</button>
            <button id="modeExam">Examen</button>
          </div>
          <button id="btnSettings" class="btn small">‚öôÔ∏è Ajustes</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="display:grid; gap:12px">
    <section id="settingsPanel" class="card hidden">
      <div class="grid two">
        <div class="card" style="background:#111723">
          <h3 style="margin:0 0 10px">Perfil e idioma</h3>
          <label>Nombre de perfil (para separar progreso)
            <input type="text" id="profileName" placeholder="Ej.: Michael o Masha" />
          </label>
          <label>Idioma UI
            <select id="uiLang"><option value="es">Espa√±ol</option><option value="ru">–†—É—Å—Å–∫–∏–π</option></select>
          </label>
          <div class="muted">Consejo: usa perfiles distintos para tener progresos separados.</div>
        </div>
        <div class="card" style="background:#111723">
          <h3 style="margin:0 0 10px">Datos</h3>
          <div class="grid">
            <div class="row">
              <label class="file btn small">üì• Importar preguntas (JSON)
                <input type="file" id="importFile" accept="application/json" />
              </label>
              <button id="btnExport" class="btn small">üì§ Exportar (preguntas+progreso)</button>
            </div>
            <button id="btnLoadLF" class="btn small">‚¨áÔ∏è Cargar pack ‚ÄúLectura F√°cil‚Äù (incluido)</button>
            <button id="btnReset" class="btn small" style="background:#2a0f14;border-color:#5a1b22">‚ôªÔ∏è Reiniciar progreso</button>
            <details>
              <summary>üìÑ Formato JSON (ejemplo)</summary>
<pre style="white-space:pre-wrap; font-size:12px; color:#cfe8ff; background:#0c121a; padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,.08)">[
  {
    "id": 1,
    "topic": "Se√±ales",
    "image": "data:image/svg+xml;utf8,...",
    "question": {"es": "¬øQu√© significa la se√±al octogonal roja?"},
    "choices": [
      {"id":"A","text":{"es":"Ceda el paso"}},
      {"id":"B","text":{"es":"Stop"}},
      {"id":"C","text":{"es":"Prohibido adelantar"}}
    ],
    "correct": ["B"],
    "explanation": {"es": "El oct√≥gono rojo significa STOP."}
  }
]</pre>
              <div class="muted">Este pack es educativo, no es la base oficial de la DGT.</div>
            </details>
          </div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end"><button id="btnCloseSettings" class="btn">Listo</button></div>
    </section>

    <section class="card">
      <div class="row" style="align-items:center; gap:10px">
        <div class="grow">
          <div class="bar"><span id="progressBar" style="width:0%"></span></div>
          <div class="muted" id="progressText" style="margin-top:6px">0 / 0</div>
        </div>
        <div class="row">
          <button id="btnPrev" class="btn small">‚óÄÔ∏é Atr√°s</button>
          <button id="btnNext" class="btn small">Siguiente ‚ñ∂Ô∏é</button>
        </div>
      </div>
    </section>

    <section id="qa" class="card" aria-live="polite" style="display:grid; gap:10px">
      <div id="topic" class="muted"></div>
      <img id="qImage" class="image hidden" alt="Imagen de la pregunta" />
      <div id="qText" class="qtxt"></div>
      <div id="choices" class="choices"></div>
      <div id="explain" class="muted hidden"></div>
      <div class="row">
        <button id="btnCheck" class="btn primary">Comprobar</button>
        <button id="btnReveal" class="btn ghost">Mostrar respuesta</button>
        <button id="btnMarkHard" class="btn ghost">‚òÖ Dif√≠cil</button>
      </div>
    </section>

    <section id="examPanel" class="card hidden">
      <div class="grid two">
        <div class="card" style="background:#111723">
          <h3 style="margin:0 0 10px">Examen</h3>
          <label>N¬∫ preguntas
            <input type="text" id="examCount" inputmode="numeric" value="30" />
          </label>
          <label>Mezclar
            <select id="examShuffle"><option value="1">S√≠</option><option value="0">No</option></select>
          </label>
          <button id="btnStartExam" class="btn">Comenzar</button>
        </div>
        <div class="card" style="background:#111723">
          <h3 style="margin:0 0 10px">Resultados</h3>
          <div id="examStats" class="muted">Sin intentos.</div>
          <div id="examReview" class="grid" style="gap:6px"></div>
        </div>
      </div>
    </section>

    <footer class="muted" style="text-align:center; padding:18px 0 8px">
      <div>Para a√±adir en iPhone: en Safari toca <strong>Compartir ‚Üí A√±adir a pantalla de inicio</strong>.</div>
      <div style="margin-top:6px">Los datos se guardan localmente. Recurso educativo (no oficial DGT).</div>
    </footer>
  </main>

  <script>
  // ==== UTIL: SVG sencillos para se√±ales (originales) ====
  const SVG = {
    stop: `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 180'><rect width='100%' height='100%' fill='#18202b'/><g transform='translate(160,90)'><polygon points='0,-60 42,-42 60,0 42,42 0,60 -42,42 -60,0 -42,-42' fill='#d94848' stroke='white' stroke-width='6'/><text x='0' y='10' font-family='Arial' font-size='40' fill='white' text-anchor='middle' font-weight='700'>STOP</text></g></svg>`)}`,
    ceda: `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 180'><rect width='100%' height='100%' fill='#18202b'/><g transform='translate(160,90)'><polygon points='0,-56 50,40 -50,40' fill='white' stroke='#e74c3c' stroke-width='12'/><text x='0' y='70' font-family='Arial' font-size='18' fill='#e7eef7' text-anchor='middle'>Ceda el paso</text></g></svg>`)}`,
    peligro: `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 180'><rect width='100%' height='100%' fill='#18202b'/><g transform='translate(160,90)'><polygon points='0,-58 50,38 -50,38' fill='yellow' stroke='red' stroke-width='8'/><text x='0' y='70' font-family='Arial' font-size='18' fill='#e7eef7' text-anchor='middle'>Se√±al de peligro</text></g></svg>`)}`,
    oblig: `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 180'><rect width='100%' height='100%' fill='#18202b'/><circle cx='160' cy='90' r='60' fill='#1e90ff' stroke='white' stroke-width='6'/><path d='M130 90h60' stroke='white' stroke-width='10' stroke-linecap='round'/></svg>`)}`,
    niebla: `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 180'><rect width='100%' height='100%' fill='#18202b'/><g fill='none' stroke='#cfe8ff' stroke-width='6'><path d='M20 80h280M40 110h240M60 140h200'/></g><text x='160' y='50' fill='#e7eef7' text-anchor='middle' font-family='Arial' font-size='18'>Niebla / lluvia intensa</text></svg>`)}`,
    paso: `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 180'><rect width='100%' height='100%' fill='#18202b'/><rect x='40' y='100' width='240' height='20' fill='white'/><rect x='40' y='70' width='240' height='10' fill='white' opacity='.5'/><circle cx='110' cy='90' r='8' fill='#e7eef7'/><rect x='106' y='98' width='8' height='20' fill='#e7eef7'/><rect x='100' y='118' width='20' height='6' fill='#e7eef7'/></svg>`)}`,
    rotonda: `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 180'><rect width='100%' height='100%' fill='#18202b'/><circle cx='160' cy='90' r='50' fill='none' stroke='#5bd4ff' stroke-width='10'/><path d='M160 40 l10 15 h-20z' fill='#5bd4ff'/><text x='160' y='160' font-family='Arial' fill='#e7eef7' text-anchor='middle'>Rotonda</text></svg>`)}`,
    velocidad: `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 180'><rect width='100%' height='100%' fill='#18202b'/><circle cx='160' cy='90' r='60' fill='white' stroke='red' stroke-width='10'/><text x='160' y='105' font-family='Arial' font-size='44' font-weight='700' text-anchor='middle' fill='#111'>50</text></svg>`)}`
  };

  // ==== Pack estilo "Lectura F√°cil" (preguntas originales, no oficiales) ====
  const lfQuestions = [
    { id:1, topic:'Se√±ales', image:SVG.stop,
      question:{es:'Esta se√±al octogonal roja significa:'},
      choices:[{id:'A',text:{es:'Ceda el paso'}},{id:'B',text:{es:'Stop (detenerse por completo)'}},{id:'C',text:{es:'Prohibido adelantar'}}],
      correct:['B'], explanation:{es:'El oct√≥gono rojo es ‚ÄúSTOP‚Äù. Detente por completo y contin√∫a cuando sea seguro.'}
    },
    { id:2, topic:'Se√±ales', image:SVG.ceda,
      question:{es:'La se√±al ‚ÄúCeda el paso‚Äù te obliga a:'},
      choices:[{id:'A',text:{es:'Detenerte siempre'}},{id:'B',text:{es:'Reducir y ceder si vienen otros'}},{id:'C',text:{es:'Pasar primero'}}],
      correct:['B'], explanation:{es:'Debes dejar pasar si hay veh√≠culos con prioridad. Si no hay riesgo, no hace falta detenerse por completo.'}
    },
    { id:3, topic:'Se√±ales', image:SVG.peligro,
      question:{es:'Una se√±al triangular con borde rojo avisa de:'},
      choices:[{id:'A',text:{es:'Obligaci√≥n'}},{id:'B',text:{es:'Peligro'}},{id:'C',text:{es:'Fin de prohibici√≥n'}}],
      correct:['B'], explanation:{es:'Tri√°ngulo con borde rojo = aviso de peligro.'}
    },
    { id:4, topic:'Alumbrado', image:SVG.niebla,
      question:{es:'¬øCu√°ndo se usan las luces antiniebla?'},
      choices:[{id:'A',text:{es:'Siempre de noche'}},{id:'B',text:{es:'Con niebla, lluvia o nieve intensas'}},{id:'C',text:{es:'Solo en ciudad'}}],
      correct:['B'], explanation:{es:'Se usan cuando baja mucho la visibilidad.'}
    },
    { id:5, topic:'Paso de peatones', image:SVG.paso,
      question:{es:'Te acercas a un paso de peatones con gente esperando. Debes:'},
      choices:[{id:'A',text:{es:'Acelerar y pasar'}},{id:'B',text:{es:'Parar y dejar pasar'}},{id:'C',text:{es:'Pitar y seguir'}}],
      correct:['B'], explanation:{es:'El peat√≥n tiene prioridad en el paso.'}
    },
    { id:6, topic:'Se√±ales', image:SVG.oblig,
      question:{es:'Un c√≠rculo azul indica:'},
      choices:[{id:'A',text:{es:'Prohibici√≥n'}},{id:'B',text:{es:'Peligro'}},{id:'C',text:{es:'Obligaci√≥n (acci√≥n obligatoria)'}}],
      correct:['C'], explanation:{es:'C√≠rculo azul = obligaci√≥n, por ejemplo direcci√≥n obligatoria.'}
    },
    { id:7, topic:'Rotondas', image:SVG.rotonda,
      question:{es:'En una rotonda, la prioridad es de:'},
      choices:[{id:'A',text:{es:'Quien entra'}},{id:'B',text:{es:'Quien circula dentro'}},{id:'C',text:{es:'Siempre el de la derecha'}}],
      correct:['B'], explanation:{es:'Tiene prioridad quien ya est√° dentro de la rotonda.'}
    },
    { id:8, topic:'Distancia', image:SVG.velocidad,
      question:{es:'Regla b√°sica de distancia de seguridad:'},
      choices:[{id:'A',text:{es:'1 segundo'}},{id:'B',text:{es:'2 segundos (o m√°s con lluvia)'}},{id:'C',text:{es:'Solo medio segundo'}}],
      correct:['B'], explanation:{es:'Al menos 2 s en condiciones normales. M√°s con lluvia o mala visibilidad.'}
    },
    { id:9, topic:'Adelantamiento', image:null,
      question:{es:'Antes de adelantar debes:'},
      choices:[{id:'A',text:{es:'Tocar el claxon siempre'}},{id:'B',text:{es:'Comprobar visibilidad, se√±alizar y que no viene nadie'}},{id:'C',text:{es:'Encender las luces de emergencia'}}],
      correct:['B'], explanation:{es:'Adelanta solo con buena visibilidad, espacio y se√±alizando.'}
    },
    { id:10, topic:'Velocidad', image:SVG.velocidad,
      question:{es:'Se√±al circular blanca con borde rojo y ‚Äú50‚Äù indica:'},
      choices:[{id:'A',text:{es:'Velocidad m√≠nima 50'}} ,{id:'B',text:{es:'Velocidad m√°xima 50'}},{id:'C',text:{es:'Recomendaci√≥n 50'}}],
      correct:['B'], explanation:{es:'Es un l√≠mite m√°ximo.'}
    },
    { id:11, topic:'Prioridad', image:null,
      question:{es:'¬øD√≥nde suele estar prohibido adelantar?'},
      choices:[{id:'A',text:{es:'En pasos de peatones'}},{id:'B',text:{es:'En autopistas'}},{id:'C',text:{es:'En v√≠as con 3 carriles por sentido'}}],
      correct:['A'], explanation:{es:'En pasos de peatones est√° prohibido por seguridad.'}
    },
    { id:12, topic:'Cintur√≥n', image:null,
      question:{es:'El cintur√≥n de seguridad:'},
      choices:[{id:'A',text:{es:'No es necesario en ciudad'}},{id:'B',text:{es:'Es obligatorio para todos los ocupantes'}},{id:'C',text:{es:'Solo para el conductor'}}],
      correct:['B'], explanation:{es:'Todos los ocupantes deben llevarlo abrochado.'}
    },
    { id:13, topic:'Ni√±os', image:null,
      question:{es:'Los menores de estatura inferior a 135 cm deben:'},
      choices:[{id:'A',text:{es:'Ir delante con cintur√≥n normal'}},{id:'B',text:{es:'Usar sistemas de retenci√≥n infantil homologados'}},{id:'C',text:{es:'Ir de pie si es trayecto corto'}}],
      correct:['B'], explanation:{es:'Siempre con SRI adecuado a su talla y peso.'}
    },
    { id:14, topic:'M√≥vil', image:null,
      question:{es:'Hablar por el m√≥vil sin manos libres al conducir:'},
      choices:[{id:'A',text:{es:'Est√° permitido a baja velocidad'}},{id:'B',text:{es:'Es peligroso y est√° prohibido'}},{id:'C',text:{es:'Es obligatorio avisar por tel√©fono'}}],
      correct:['B'], explanation:{es:'Distrae y aumenta el riesgo de accidente.'}
    },
    { id:15, topic:'Lluvia', image:SVG.niebla,
      question:{es:'Con lluvia intensa debes:'},
      choices:[{id:'A',text:{es:'Aumentar distancia y reducir velocidad'}},{id:'B',text:{es:'Mantener la misma velocidad'}},{id:'C',text:{es:'Apagar luces'}}],
      correct:['A'], explanation:{es:'La adherencia baja, aumenta la distancia y reduce la velocidad.'}
    },
    { id:16, topic:'Estacionamiento', image:null,
      question:{es:'Si aparcas en pendiente:'},
      choices:[{id:'A',text:{es:'Usa freno de mano y deja una marcha puesta'}},{id:'B',text:{es:'Solo freno de pie'}},{id:'C',text:{es:'Apaga el motor y nada m√°s'}}],
      correct:['A'], explanation:{es:'Asegura el veh√≠culo con freno de estacionamiento y una marcha.'}
    },
    { id:17, topic:'Ciclistas', image:null,
      question:{es:'Al adelantar a una bicicleta en v√≠a interurbana:'},
      choices:[{id:'A',text:{es:'Distancia lateral m√≠nima 1,5 m'}},{id:'B',text:{es:'No hay distancia m√≠nima'}},{id:'C',text:{es:'Pita para que te oiga'}}],
      correct:['A'], explanation:{es:'Mant√©n al menos 1,5 m y reduce velocidad.'}
    },
    { id:18, topic:'Autopista', image:null,
      question:{es:'En autopista/autov√≠a est√° prohibido:'},
      choices:[{id:'A',text:{es:'Circular marcha atr√°s'}},{id:'B',text:{es:'Adelantar por la izquierda'}},{id:'C',text:{es:'Usar carriles'}}],
      correct:['A'], explanation:{es:'Prohibid√≠simo: nunca marcha atr√°s salvo por indicaci√≥n de la autoridad.'}
    }
  ];

  // ==== Estado y almacenamiento ====
  const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
  const storeKey = p=>`dgt_trainer_v2::${p||'default'}`;
  const loadState = p=>{ try{return JSON.parse(localStorage.getItem(storeKey(p)))||{};}catch{return{}} };
  const saveState = (p,d)=>localStorage.setItem(storeKey(p), JSON.stringify(d));

  let UI_LANG = localStorage.getItem('uiLang') || 'es';
  let PROFILE = localStorage.getItem('profileName') || 'Michael';
  let DATA = { questions: [], progress:{seen:{},correct:{},hard:{}}, exams:[], practiceSel:{} };

  function initData(){
    const saved = loadState(PROFILE);
    if(saved && saved.questions && saved.questions.length){ DATA=saved; }
    else { DATA.questions = lfQuestions; saveState(PROFILE, DATA); }
  }

  // ==== Render ====
  let MODE='practice'; let INDEX=0; let EXAM=null; // {order:[], answers:{qid:[ids]}, startedAt}

  function setMode(m){
    MODE=m; $('#modePractice').classList.toggle('active',m==='practice'); $('#modeExam').classList.toggle('active',m==='exam');
    $('#examPanel').classList.toggle('hidden', m!=='exam'); $('#qa').classList.toggle('hidden', m==='exam' && !EXAM);
    updateProgress();
  }
  function updateProgress(){
    const total = MODE==='exam' && EXAM? EXAM.order.length : DATA.questions.length;
    const current = MODE==='exam' && EXAM? (EXAM.order.indexOf(INDEX)+1) : (INDEX+1);
    $('#progressBar').style.width = (total?Math.round(current*100/total):0)+'%';
    $('#progressText').textContent = `${current} / ${total}`;
  }
  function renderQuestion(){
    const q = DATA.questions[INDEX]; if(!q) return;
    $('#topic').textContent = q.topic||'';
    const img=$('#qImage'); if(q.image){ img.src=q.image; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
    $('#qText').textContent = q.question[UI_LANG] || q.question.es || '';
    const choices=$('#choices'); choices.innerHTML='';
    (q.choices||[]).forEach(ch=>{
      const lab=document.createElement('label'); lab.className='choice'; lab.dataset.id=ch.id;
      lab.innerHTML = `<input type="checkbox" /> <div><strong>${ch.id}</strong>. ${ch.text[UI_LANG]||ch.text.es}</div>`;
      lab.addEventListener('click',e=>{ if(e.target.tagName.toLowerCase()!=='input'){ const inp=lab.querySelector('input'); inp.checked=!inp.checked; } });
      choices.appendChild(lab);
    });
    const prevSel = (MODE==='practice')? (DATA.practiceSel[q.id]||[]) : (EXAM?.answers[q.id]||[]);
    prevSel.forEach(id=>{ const el=$(`#choices .choice[data-id="${id}"] input`); if(el) el.checked=true; });
    $('#explain').classList.add('hidden'); $('#explain').textContent='';
    updateProgress();
  }
  function getSelected(){ return $$('#choices .choice').filter(c=>c.querySelector('input').checked).map(c=>c.dataset.id); }
  function markChoiceStates(correctSet, selected){
    $$('#choices .choice').forEach(el=>{ const id=el.dataset.id; el.classList.remove('correct','incorrect'); if(selected.includes(id)){ el.classList.add(correctSet.has(id)?'correct':'incorrect'); } });
  }

  function checkAnswer(showOnly=false){
    const q = DATA.questions[INDEX]; const correctSet=new Set(q.correct||[]); const selected=getSelected();
    if(MODE==='practice' && !showOnly){ DATA.practiceSel[q.id]=selected; }
    if(MODE==='exam' && EXAM && !showOnly){ EXAM.answers[q.id]=selected; }
    markChoiceStates(correctSet, showOnly? Array.from(correctSet): selected);
    if(!showOnly){
      DATA.progress.seen[q.id]=(DATA.progress.seen[q.id]||0)+1;
      const right = selected.length===correctSet.size && selected.every(x=>correctSet.has(x));
      if(right){ DATA.progress.correct[q.id]=(DATA.progress.correct[q.id]||0)+1; }
      saveState(PROFILE, DATA);
    }
    const ansLabel = (UI_LANG==='es'?'Respuesta correcta: ':'–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ')+ (q.correct||[]).join(', ');
    $('#explain').innerHTML = `<div style="margin-bottom:6px"><strong>${ansLabel}</strong></div>` + (q.explanation?.[UI_LANG] || q.explanation?.es || '');
    $('#explain').classList.remove('hidden');
  }

  function next(){ if(MODE==='exam' && EXAM){ const pos=EXAM.order.indexOf(INDEX); if(pos<EXAM.order.length-1){ INDEX=EXAM.order[pos+1]; renderQuestion(); } else { finishExam(); } } else { INDEX=(INDEX+1)%DATA.questions.length; renderQuestion(); } }
  function prev(){ if(MODE==='exam' && EXAM){ const pos=EXAM.order.indexOf(INDEX); if(pos>0){ INDEX=EXAM.order[pos-1]; renderQuestion(); } } else { INDEX=(INDEX-1+DATA.questions.length)%DATA.questions.length; renderQuestion(); } }

  // ==== Examen ====
  function startExam(){
    const all = DATA.questions.map((_,i)=>i); const count = Math.min(Math.max(parseInt($('#examCount').value||'30',10),1), all.length);
    const shuffled = $('#examShuffle').value==='1' ? all.sort(()=>Math.random()-0.5) : all;
    EXAM={ order: shuffled.slice(0,count), answers:{}, startedAt: Date.now() };
    INDEX = EXAM.order[0]; $('#qa').classList.remove('hidden'); renderQuestion();
  }
  function finishExam(){
    let ok=0; const total = EXAM.order.length; const review=[];
    EXAM.order.forEach(i=>{ const q=DATA.questions[i]; const sel=EXAM.answers[q.id]||[]; const set=new Set(q.correct||[]); const right = sel.length===set.size && sel.every(x=>set.has(x)); if(right) ok++; review.push({q, sel, right}); });
    const attempt = {at:Date.now(), total, correct:ok}; DATA.exams.push(attempt); saveState(PROFILE, DATA);
    const stats = (UI_LANG==='es'?`Resultado: ${ok} de ${total}`:`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${ok} –∏–∑ ${total}`); $('#examStats').textContent = stats;
    const box=$('#examReview'); box.innerHTML=''; review.forEach(item=>{ const div=document.createElement('div'); div.className='muted'; const s=item.sel.join(', ')||'‚Äî'; div.textContent = `${item.right?'‚úÖ':'‚ùå'} ${item.q.question.es} | Tu: ${s} | OK: ${(item.q.correct||[]).join(', ')}`; box.appendChild(div); });
    setMode('exam');
  }
  function renderExamHistory(){ const box=$('#examReview'); box.innerHTML=''; if(!DATA.exams.length){ $('#examStats').textContent='Sin intentos.'; return; } const last=DATA.exams[DATA.exams.length-1]; $('#examStats').textContent=`Resultado: ${last.correct} / ${last.total}`; DATA.exams.slice().reverse().forEach(at=>{ const div=document.createElement('div'); div.className='muted'; div.textContent = `${new Date(at.at).toLocaleString()} ‚Äî ${at.correct}/${at.total}`; box.appendChild(div); }); }

  // ==== Ajustes / Import / Export ====
  function openSettings(){ $('#settingsPanel').classList.remove('hidden'); $('#profileName').value=PROFILE; $('#uiLang').value=UI_LANG; }
  function closeSettings(){ PROFILE=($('#profileName').value||'default').trim()||'default'; UI_LANG=$('#uiLang').value||'es'; localStorage.setItem('profileName',PROFILE); localStorage.setItem('uiLang',UI_LANG); initData(); INDEX=0; renderQuestion(); renderExamHistory(); $('#settingsPanel').classList.add('hidden'); }

  $('#importFile').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; try{ const text=await f.text(); const arr=JSON.parse(text); if(!Array.isArray(arr)||!arr.length) throw new Error('JSON debe ser un array.'); for(const q of arr){ if(typeof q.id==='undefined') q.id=Math.random().toString(36).slice(2); if(!q.question||!q.choices||!q.correct) throw new Error('Campos requeridos: question, choices, correct'); } DATA.questions=arr; DATA.progress={seen:{},correct:{},hard:{}}; DATA.practiceSel={}; saveState(PROFILE, DATA); INDEX=0; renderQuestion(); alert('Preguntas importadas.'); }catch(err){ alert('Error al importar: '+err.message); } e.target.value=''; });
  $('#btnExport').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(DATA,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`dgt_trainer_${PROFILE}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1500); });
  $('#btnReset').addEventListener('click', ()=>{ if(confirm('¬øReiniciar progreso local?')){ DATA.progress={seen:{},correct:{},hard:{}}; DATA.practiceSel={}; DATA.exams=[]; saveState(PROFILE, DATA); alert('Progreso reiniciado.'); }});
  $('#btnLoadLF').addEventListener('click', ()=>{ if(confirm('Cargar el pack de ejemplo ‚ÄúLectura F√°cil‚Äù? Esto sustituir√° la base actual.')){ DATA.questions=lfQuestions; DATA.progress={seen:{},correct:{},hard:{}}; DATA.practiceSel={}; saveState(PROFILE, DATA); INDEX=0; renderQuestion(); alert('Pack cargado.'); }});

  // ==== Eventos de UI ====
  $('#modePractice').addEventListener('click', ()=>{ setMode('practice'); $('#qa').classList.remove('hidden'); renderQuestion(); });
  $('#modeExam').addEventListener('click', ()=>{ setMode('exam'); renderExamHistory(); $('#qa').classList.add('hidden'); });
  $('#btnSettings').addEventListener('click', openSettings); $('#btnCloseSettings').addEventListener('click', closeSettings);
  $('#btnPrev').addEventListener('click', prev); $('#btnNext').addEventListener('click', next);
  $('#btnCheck').addEventListener('click', ()=>checkAnswer(false)); $('#btnReveal').addEventListener('click', ()=>checkAnswer(true));
  $('#btnMarkHard').addEventListener('click', ()=>{ const q=DATA.questions[INDEX]; DATA.progress.hard[q.id]=!DATA.progress.hard[q.id]; saveState(PROFILE, DATA); alert(DATA.progress.hard[q.id]?'Marcado como dif√≠cil.':'Quitada la marca.'); });
  $('#btnStartExam').addEventListener('click', startExam);

  // ==== Boot ====
  (function(){ initData(); setMode('practice'); renderQuestion(); renderExamHistory(); document.addEventListener('touchstart',()=>{}, {passive:true}); })();
  </script>
</body>
</html>
